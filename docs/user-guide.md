# Ankismart 用户指南

## 目录

1. [简介](#简介)
2. [安装与配置](#安装与配置)
3. [快速开始](#快速开始)
4. [功能详解](#功能详解)
5. [卡片生成策略](#卡片生成策略)
6. [数学公式支持](#数学公式支持)
7. [长文档分割](#长文档分割)
8. [常见问题](#常见问题)

---

## 简介

Ankismart 是一款智能 Anki 闪卡生成工具，能够将各种格式的文档自动转换为高质量的 Anki 学习卡片。

### 主要特性

- **多格式支持**：支持 Markdown、Word (DOCX)、PowerPoint (PPTX)、PDF、图片等格式
- **智能 OCR**：内置 PaddleOCR，自动识别图片和 PDF 中的文字
- **8 种生成策略**：提供多种卡片生成策略，适应不同学习场景
- **数学公式支持**：完整支持 LaTeX 数学公式，使用 MathJax 渲染
- **批量处理**：支持一次导入多个文档，批量生成卡片
- **实时预览**：生成前可预览和编辑每张卡片
- **灵活导出**：支持直接推送到 Anki 或导出为 .apkg 文件
- **多语言界面**：支持中文和英文界面

---

## 安装与配置

### 系统要求

- **操作系统**：Windows 10/11、macOS、Linux
- **Python 版本**：Python 3.11 或更高
- **内存**：建议 4GB 以上（使用 OCR 功能时建议 8GB）
- **磁盘空间**：至少 2GB（OCR 模型约 500MB）

### 安装步骤

#### 方法一：使用预编译版本（推荐）

1. 从 [Releases](https://github.com/your-repo/ankismart/releases) 页面下载最新版本
2. 解压到任意目录
3. 运行 `Ankismart.exe`（Windows）或对应的可执行文件

#### 方法二：从源码安装

```bash
# 1. 克隆仓库
git clone https://github.com/your-repo/ankismart.git
cd ankismart

# 2. 创建虚拟环境
python -m venv .venv

# 3. 激活虚拟环境
# Windows:
.venv\Scripts\activate
# macOS/Linux:
source .venv/bin/activate

# 4. 安装依赖
pip install -e .

# 5. 运行应用
python -m ankismart.ui.app
```

### 初次配置

首次启动 Ankismart 后，需要进行以下配置：

#### 1. 配置 LLM 提供商

Ankismart 使用大语言模型（LLM）生成卡片，需要配置至少一个 LLM 提供商。

1. 点击左侧导航栏的 **"设置"** 图标
2. 在 **"LLM 配置"** 部分，点击 **"添加提供商"**
3. 填写以下信息：
   - **提供商名称**：例如 "OpenAI"、"DeepSeek" 等
   - **基础 URL**：API 端点地址
   - **API 密钥**：您的 API Key
   - **模型**：要使用的模型名称
   - **RPM 限制**：每分钟请求数限制（可选，0 表示无限制）

**常用提供商配置示例：**

| 提供商 | 基础 URL | 推荐模型 |
|--------|----------|----------|
| OpenAI | `https://api.openai.com/v1` | `gpt-4o`, `gpt-4o-mini` |
| DeepSeek | `https://api.deepseek.com` | `deepseek-chat` |
| Moonshot | `https://api.moonshot.cn/v1` | `moonshot-v1-8k` |
| 智谱 AI | `https://open.bigmodel.cn/api/paas/v4` | `glm-4` |
| 通义千问 | `https://dashscope.aliyuncs.com/compatible-mode/v1` | `qwen-turbo` |
| Ollama（本地） | `http://localhost:11434/v1` | `llama3`, `qwen2` |

4. 点击 **"保存"**
5. 点击 **"测试"** 按钮验证连接是否正常
6. 点击 **"激活"** 设置为当前使用的提供商

#### 2. 配置 AnkiConnect

要将卡片直接推送到 Anki，需要安装并配置 AnkiConnect 插件。

**安装 AnkiConnect：**

1. 打开 Anki 桌面应用
2. 选择 **工具 → 插件 → 获取插件**
3. 输入插件代码：`2055492159`
4. 重启 Anki

**配置 AnkiConnect：**

1. 在 Ankismart 设置页面，找到 **"Anki 配置"** 部分
2. 填写以下信息：
   - **AnkiConnect URL**：默认为 `http://127.0.0.1:8765`
   - **AnkiConnect 密钥**：如果您在 Anki 中设置了密钥，请填写（可选）
   - **默认牌组**：新卡片的默认牌组名称（例如 "Default"）
   - **默认标签**：新卡片的默认标签，用逗号分隔（例如 "ankismart, imported"）

3. 点击 **"测试连接"** 验证配置是否正确
4. 点击 **"保存配置"**

#### 3. 其他设置（可选）

- **主题**：选择浅色、深色或自动主题
- **语言**：选择中文或英文界面
- **代理设置**：如果需要通过代理访问 LLM API，填写代理 URL
- **OCR 校正**：启用后使用 LLM 自动校正 OCR 识别错误（会增加 API 调用次数）
- **LLM 参数**：
  - **温度**：控制生成的随机性（0.0 = 确定性，2.0 = 创造性），推荐 0.3-0.7
  - **最大令牌数**：生成的最大令牌数，0 表示使用提供商默认值

---

## 快速开始

### 基本工作流程

```
导入文档 → 选择策略 → 生成卡片 → 预览编辑 → 导出到 Anki
```

### 步骤详解

#### 1. 导入文档

1. 点击左侧导航栏的 **"导入"** 图标
2. 通过以下方式添加文档：
   - 点击 **"选择文件"** 按钮浏览文件
   - 直接拖拽文件到文件列表区域
3. 支持的文件格式：
   - Markdown (`.md`)
   - Word 文档 (`.docx`)
   - PowerPoint 演示文稿 (`.pptx`)
   - PDF 文档 (`.pdf`)
   - 图片 (`.png`, `.jpg`, `.jpeg`, `.bmp`)
   - 纯文本 (`.txt`)

#### 2. 配置生成选项

在导入页面底部，配置以下选项：

- **目标牌组**：选择或输入目标 Anki 牌组名称
- **标签**：为生成的卡片添加标签，用逗号分隔
- **生成策略**：选择适合的卡片生成策略（详见[卡片生成策略](#卡片生成策略)）
- **更新模式**：
  - **仅添加新卡片**：只添加新卡片，不修改已存在的卡片
  - **更新已存在的卡片**：更新已存在的卡片内容

#### 3. 生成卡片

1. 点击 **"开始生成"** 按钮
2. 等待文档转换和卡片生成（进度条会显示当前状态）
3. 生成完成后自动跳转到预览页面

#### 4. 预览和编辑

在预览页面，您可以：

- **查看所有卡片**：左侧列表显示所有生成的卡片
- **编辑卡片内容**：
  - 点击卡片可查看详情
  - 点击 **"编辑"** 按钮修改正面和背面内容
  - 支持 Markdown 和 LaTeX 公式
- **删除卡片**：点击 **"删除"** 按钮移除不需要的卡片
- **实时预览**：右侧显示卡片的渲染效果

#### 5. 导出卡片

预览确认后，选择导出方式：

- **推送到 Anki**：点击 **"推送到 Anki"** 按钮，卡片将直接添加到 Anki（需要 Anki 正在运行且 AnkiConnect 已配置）
- **导出为 .apkg**：点击 **"导出 APKG"** 按钮，保存为 Anki 包文件，可稍后手动导入

---

## 功能详解

### 文档转换

Ankismart 会自动检测文档类型并使用相应的转换器：

#### Markdown 文档
- 保留原始格式和结构
- 支持代码块、表格、列表等
- 自动提取数学公式

#### Word 文档 (DOCX)
- 提取文本内容和基本格式
- 保留标题层级
- 支持表格和列表

#### PowerPoint (PPTX)
- 逐页提取内容
- 保留标题和正文
- 提取备注内容

#### PDF 和图片
- 使用 PaddleOCR 进行文字识别
- 支持中英文混合识别
- 可选 LLM 校正功能提高准确率
- 首次使用会自动下载 OCR 模型（约 500MB）

#### 纯文本 (TXT)
- 自动检测编码（支持 UTF-8、GBK 等）
- 保留原始格式

### 批量处理

Ankismart 支持一次处理多个文档：

1. 在导入页面添加多个文件
2. 所有文件将使用相同的生成策略和配置
3. 生成的卡片会合并到同一个预览列表
4. 可以统一导出或分别处理

### 卡片编辑

在预览页面，每张卡片都可以单独编辑：

- **Markdown 支持**：使用 Markdown 语法格式化文本
- **公式编辑**：使用 `$...$` 或 `$$...$$` 插入 LaTeX 公式
- **实时预览**：编辑时右侧实时显示渲染效果
- **撤销/重做**：支持编辑历史记录

### 导出选项

#### 推送到 Anki
- 要求 Anki 正在运行
- 自动创建不存在的牌组
- 支持更新已存在的卡片
- 自动添加标签

#### 导出 APKG
- 生成标准 Anki 包文件
- 可在任何设备上导入
- 包含所有卡片数据和格式
- 支持数学公式渲染

---

## 卡片生成策略

Ankismart 提供 8 种卡片生成策略，适应不同的学习场景和内容类型。

### 1. 基础问答 (Basic Q&A)

**适用场景：**
- 通用学习材料
- 概念性知识
- 事实性信息

**卡片格式：**
- 正面：问题
- 背面：答案

**示例：**
```
正面：什么是光合作用？
背面：光合作用是植物将光能转化为化学能的过程，利用二氧化碳和水产生葡萄糖和氧气。
```

**特点：**
- 问题简洁明确
- 答案直接且信息丰富
- 适合快速复习

### 2. 填空题 (Cloze Deletion)

**适用场景：**
- 需要记忆关键术语
- 定义和公式
- 重要数字和日期

**卡片格式：**
- 使用 `{{c1::内容}}` 语法创建填空
- 支持多个填空 `{{c1::...}}`, `{{c2::...}}`

**示例：**
```
光合作用将 {{c1::光能}} 转化为 {{c2::化学能}}，产生葡萄糖。
```

**特点：**
- 上下文完整
- 精确记忆关键信息
- 适合术语和定义

### 3. 图片问答 (Image-based Q&A)

**适用场景：**
- 图表和示意图
- 标注图片
- 视觉学习材料

**卡片格式：**
- 正面：关于图片元素的问题
- 背面：答案，包含位置和关系描述

**示例：**
```
正面：在细胞图中，负责能量产生的细胞器是什么？
背面：线粒体 - 位于细胞质中，将营养物质转化为 ATP。
```

**特点：**
- 强调视觉元素
- 包含空间关系
- 适合图解内容

### 4. 概念解释 (Concept Explanation)

**适用场景：**
- 深度理解概念
- 理论知识
- 需要详细解释的主题

**卡片格式：**
- 正面：概念名称
- 背面：详细解释（原理、意义、示例）

**示例：**
```
正面：光合作用
背面：光合作用是绿色植物将光能转化为化学能的生物过程。它发生在叶绿体中，分为两个阶段：光反应（在类囊体中）和暗反应（在基质中）。意义：它是地球上氧气和有机物的主要来源。例如：叶片呈绿色是因为叶绿素反射绿光而吸收红光和蓝光。
```

**特点：**
- 解释全面深入
- 包含原理和示例
- 适合理解性学习

### 5. 关键术语 (Key Terms)

**适用场景：**
- 专业术语学习
- 词汇积累
- 技术文档

**卡片格式：**
- 正面：术语
- 背面：定义 + 例句

**示例：**
```
正面：叶绿体
背面：定义：植物细胞中进行光合作用的膜结合细胞器，含有叶绿素，能捕获光能。

例句："叶片细胞中的叶绿体使植物呈现绿色，并使其能够利用阳光产生葡萄糖。"
```

**特点：**
- 定义准确
- 提供使用语境
- 适合术语记忆

### 6. 单选题 (Single Choice)

**适用场景：**
- 考试准备
- 知识测试
- 辨析相似概念

**卡片格式：**
- 正面：问题 + 4 个选项（A/B/C/D）
- 背面：正确答案 + 简短解释

**示例：**
```
正面：$f(x) = x^3$ 的导数是什么？

A. $2x^2$
B. $3x^2$
C. $x^2$
D. $3x$

背面：B

使用幂法则 $\frac{d}{dx}(x^n) = nx^{n-1}$，得到 $f'(x) = 3x^2$。
```

**特点：**
- 模拟考试场景
- 训练辨析能力
- 包含解题思路

### 7. 多选题 (Multiple Choice)

**适用场景：**
- 复杂知识点
- 多个正确答案的情况
- 综合性测试

**卡片格式：**
- 正面：问题 + 4-5 个选项
- 背面：所有正确答案 + 解释

**示例：**
```
正面：以下哪些是 $x^2 - 5x + 6 = 0$ 的解？

A. $x = 1$
B. $x = 2$
C. $x = 3$
D. $x = 6$

背面：B, C

因式分解得 $(x-2)(x-3) = 0$，所以 $x = 2$ 或 $x = 3$。
```

**特点：**
- 考察全面性
- 多个知识点结合
- 适合综合复习

### 8. 自定义策略

**适用场景：**
- 特殊需求
- 自定义格式
- 实验性用途

**说明：**
- 可以通过修改提示词自定义生成逻辑
- 需要一定的技术背景
- 详见开发者文档

---

## 数学公式支持

Ankismart 完整支持 LaTeX 数学公式，使用 MathJax 在 Anki 中渲染。

### 公式语法

#### 行内公式
使用单个 `$` 包裹：

```
勾股定理：$a^2 + b^2 = c^2$
```

渲染效果：勾股定理：$a^2 + b^2 = c^2$

#### 独立公式
使用双 `$$` 包裹：

```
$$
\int_0^\infty e^{-x^2} dx = \frac{\sqrt{\pi}}{2}
$$
```

渲染效果：
$$
\int_0^\infty e^{-x^2} dx = \frac{\sqrt{\pi}}{2}
$$

### 常用公式示例

#### 分数
```
$\frac{a}{b}$, $\frac{dy}{dx}$
```

#### 上下标
```
$x^2$, $x_i$, $x^{2n}$, $x_{i,j}$
```

#### 根号
```
$\sqrt{2}$, $\sqrt[3]{8}$
```

#### 求和与积分
```
$\sum_{i=1}^{n} x_i$, $\int_a^b f(x) dx$
```

#### 希腊字母
```
$\alpha$, $\beta$, $\gamma$, $\Delta$, $\pi$, $\Omega$
```

#### 矩阵
```
$$
\begin{pmatrix}
a & b \\
c & d
\end{pmatrix}
$$
```

#### 方程组
```
$$
\begin{cases}
x + y = 5 \\
2x - y = 1
\end{cases}
$$
```

### 注意事项

1. **转义字符**：在 JSON 中需要双重转义反斜杠，例如 `\\frac` 而不是 `\frac`
2. **Anki 配置**：确保 Anki 已启用 MathJax 支持（默认启用）
3. **预览**：在 Ankismart 预览页面可以实时查看公式渲染效果
4. **兼容性**：生成的卡片在 Anki 桌面版、AnkiWeb 和移动端都能正确显示

---

## 长文档分割

对于超长文档，Ankismart 提供实验性的自动分割功能。

### 功能说明

当文档字符数超过设定阈值时，自动将文档分割为多个片段，分别生成卡片，最后合并结果。

### 启用方法

1. 进入 **设置** 页面
2. 找到 **"实验性功能"** 部分
3. 启用 **"启用长文档自动分割"**
4. 设置 **"分割阈值"**（默认 70,000 字符）
5. 点击 **"保存配置"**

### 工作原理

1. 检测文档长度
2. 如果超过阈值，按段落智能分割
3. 每个片段独立生成卡片
4. 合并所有片段的卡片
5. 去重和优化

### 注意事项

⚠️ **警告：这是实验性功能，可能影响卡片质量和生成时间。**

- **优点**：
  - 可以处理超长文档
  - 避免 LLM 上下文长度限制
  - 提高生成成功率

- **缺点**：
  - 可能丢失跨片段的上下文
  - 生成时间更长
  - API 调用次数增加
  - 可能产生重复卡片

- **建议**：
  - 仅在处理超长文档时启用
  - 优先考虑手动分割文档
  - 生成后仔细检查卡片质量
  - 根据文档类型调整阈值

---

## 常见问题

### 安装和配置

**Q: 首次运行时提示缺少 OCR 模型怎么办？**

A: Ankismart 会在首次使用 OCR 功能时自动下载模型（约 500MB）。请确保网络连接正常，等待下载完成。如果下载失败，可以手动下载模型文件并放置到 `~/.paddleocr/` 目录。

**Q: 如何配置代理？**

A: 在设置页面的 "其他设置" 部分，填写代理 URL，格式为 `http://proxy.example.com:8080` 或 `socks5://proxy.example.com:1080`。

**Q: 支持哪些 LLM 提供商？**

A: Ankismart 支持所有兼容 OpenAI API 格式的提供商，包括 OpenAI、DeepSeek、Moonshot、智谱 AI、通义千问、Ollama 等。只需填写正确的 API 端点和密钥即可。

### 使用问题

**Q: 生成的卡片数量太少或太多怎么办？**

A: 卡片数量由 LLM 根据内容密度自动决定（通常 3-10 张）。如果不满意，可以：
- 调整文档内容的详细程度
- 尝试不同的生成策略
- 在预览页面手动添加或删除卡片

**Q: OCR 识别不准确怎么办？**

A: 可以尝试以下方法：
- 启用 "OCR 校正" 功能（在设置中）
- 使用更高分辨率的图片或 PDF
- 确保文字清晰、对比度高
- 手动编辑识别结果

**Q: 数学公式显示不正确？**

A: 检查以下几点：
- 确保使用正确的 LaTeX 语法
- 行内公式使用 `$...$`，独立公式使用 `$$...$$`
- 在 Ankismart 预览页面检查渲染效果
- 确保 Anki 已启用 MathJax 支持

**Q: 推送到 Anki 失败？**

A: 请检查：
- Anki 是否正在运行
- AnkiConnect 插件是否已安装（代码：2055492159）
- AnkiConnect URL 是否正确（默认 `http://127.0.0.1:8765`）
- 防火墙是否阻止了连接
- 在设置页面点击 "测试连接" 验证配置

**Q: 如何更新已存在的卡片？**

A: 在导入页面选择 "更新模式" 为 "更新已存在的卡片"。Ankismart 会根据卡片内容匹配已存在的卡片并更新。

### 性能问题

**Q: 生成卡片很慢怎么办？**

A: 可能的原因和解决方法：
- **网络延迟**：检查网络连接，考虑使用国内 LLM 提供商
- **文档太长**：启用长文档分割功能，或手动分割文档
- **OCR 处理**：OCR 识别需要时间，请耐心等待
- **LLM 响应慢**：尝试更换提供商或模型

**Q: 应用占用内存过高？**

A: OCR 功能会占用较多内存（特别是处理大图片时）。建议：
- 关闭不必要的其他应用
- 处理完成后重启应用释放内存
- 使用较小的图片或 PDF

### 其他问题

**Q: 如何备份配置？**

A: 配置文件位于：
- Windows: `%USERPROFILE%\.local\ankismart\config.yaml`
- macOS/Linux: `~/.local/ankismart/config.yaml`

复制此文件即可备份配置。

**Q: 如何重置所有设置？**

A: 在设置页面点击 "重置设置" → "恢复默认"，或删除配置文件后重启应用。

**Q: 支持哪些语言？**

A: 界面支持中文和英文。卡片内容语言由源文档决定，LLM 会自动匹配文档语言生成卡片。

**Q: 如何报告 Bug 或提出建议？**

A: 请访问 [GitHub Issues](https://github.com/your-repo/ankismart/issues) 提交问题或建议。

---

## 获取帮助

- **文档**：[完整文档](https://github.com/your-repo/ankismart/docs)
- **FAQ**：[常见问题解答](./faq.md)
- **Issues**：[GitHub Issues](https://github.com/your-repo/ankismart/issues)
- **讨论**：[GitHub Discussions](https://github.com/your-repo/ankismart/discussions)

---

**版本**：v0.1.0
**最后更新**：2026-02-12
