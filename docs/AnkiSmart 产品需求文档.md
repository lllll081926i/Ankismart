# AnkiSmart 产品需求文档

**文档版本**：3.0
**创建日期**：2026年2月10日
**更新日期**：2026年2月11日  
**文档角色**：产品定义与全量需求母本（Single Source of Truth）

---

## 1. 产品定义

### 1.1 产品定位

AnkiSmart 是一个面向 Windows 桌面的智能学习工具，核心目标是将多格式学习资料自动转化为可导入 Anki 的高质量闪卡。

统一价值链：

`多格式输入 → Markdown 标准化 → 智能生成卡片 → 审阅编辑 → 写入 Anki / 导出 APKG`

### 1.2 分发与授权策略（非商用）

本项目采用**源码公开、限制商用**的分发策略：

- 源代码公开，接受社区协作。
- 允许个人学习、教学、科研等非商用场景使用。
- 禁止未经授权的商业化使用（包括但不限于二次售卖、付费托管、企业内商业服务集成）。
- 商业使用需获得项目方单独授权。

> 说明：本策略属于“非商用源码分发”范畴，具体法律条款以仓库后续提供的许可证文本为准。

### 1.3 产品愿景

成为中文学习场景下最稳定、最高效、可追溯的 Anki 制卡基础设施。

### 1.4 目标用户

- 学生：医学、法学、语言学习、考研考证等高记忆密度人群。
- 专业人士：需要持续更新知识库的从业者。
- Anki 深度用户：有既有牌组体系、强调效率和质量控制的用户。

---

## 2. 产品目标与成功指标

### 2.1 北极星目标

显著降低用户从“资料”到“可复习卡片”的时间与操作复杂度。

### 2.2 量化指标

- 制卡时间缩短：相对手工流程平均降低 ≥ 50%。
- 转换成功率：文档标准化成功率 ≥ 98%（按文件计）。
- 写入成功率：Anki 写入成功率 ≥ 99%（按卡片计，剔除用户配置错误）。
- 可用性：首次安装并完成首张卡片生成成功率 ≥ 90%。

### 2.3 指标口径定义

- 文档标准化成功：输出非空 Markdown 且通过结构完整性校验。
- 写入成功：AnkiConnect 返回成功 ID，或 APKG 导出并可导入。
- 端到端成功：从导入到推送/导出完整流程无阻断错误。

---

## 3. 产品边界

### 3.1 范围内（In Scope）

- Windows 桌面端（PySide6）
- 多格式导入与标准化（`docx`、`pptx`、`txt`、`md`、`pdf`、常见图片）
- OCR 识别与回退
- LLM 卡片生成与结构化（8 种策略）
- 多 LLM 供应商管理（含本地模型 Ollama）
- 卡片审阅、逐张编辑与批量操作
- AnkiConnect 写入与 APKG 导出
- 配置管理、日志追踪、错误治理

### 3.2 范围外（Out of Scope）

- 直接改写 Anki 同步协议
- WebDAV 直接同步 Anki 数据库
- 移动端原生应用（独立 iOS/Android 客户端）
- 非 Windows 平台首发支持（后续评估）

---

## 4. 全周期版本设计

### 4.1 阶段划分

#### v1.0：完整可用版

目标：全功能主价值链闭环，覆盖全部核心制卡能力。

- 已实现能力：
  - `pptx`、`docx`、`txt`、`md`、`pdf`、常见图片导入。
  - 文档统一转 Markdown，失败可回退。
  - LLM 生成全部 8 种卡片策略：`Basic`、`Cloze`、`Concept`、`Key Terms`、`Single Choice`、`Multiple Choice`、`Image QA`、`Image Occlusion`。
  - 6 家 LLM 供应商支持（OpenAI、DeepSeek、Moonshot、智谱、通义千问、Ollama 本地）。
  - AnkiConnect 写入（version:6）+ APKG 导出降级。
  - 逐张卡片编辑（字段编辑、删除）与卡片更新。
  - traceId、错误码、关键耗时记录。
  - API Key 加密存储、代理配置、temperature/max_tokens 参数。
  - PySide6 完整 GUI（导入页、预览页、结果页、设置页）。
  - OCR 按需下载与逐页进度回调。

#### v1.1：增强版

目标：提升批量处理效率与 OCR 质量。

- 批量高级编排（并发调度、任务队列、错误汇总）。
- OCR 复杂版面与多语言识别优化。
- 性能监控面板增强。
- 高级导出选项。
- 打包分发方案（安装包 / 便携版）。

#### v1.2+：生态版

目标：扩展协作与生态能力。

- 社区模板与模板共享。
- 高级学习分析与复习建议。
- 多平台可行性评估与迁移方案。
- 云 OCR 适配层。

### 4.2 全量能力矩阵（按阶段）

| 能力域 | v1.0 | v1.1 | v1.2+ |
|---|---|---|---|
| 多格式导入 | ✅ | ✅ | ✅ |
| OCR 回退 | ✅ | ✅（复杂版面优化） | ✅（云 OCR） |
| 8 种卡片策略 | ✅ | ✅ | ✅ |
| 逐张卡片编辑 | ✅ | ✅ | ✅ |
| 卡片更新 | ✅ | ✅ | ✅ |
| 批量高级编排 | 基础串行 | ✅ | ✅ |
| AnkiConnect 写入 | ✅ | ✅ | ✅ |
| APKG 导出 | ✅ | ✅ | ✅ |
| 多供应商 + 本地 LLM | ✅ | ✅ | ✅ |
| 打包分发 | - | ✅ | ✅ |
| 社区模板 | - | - | ✅ |

---

## 5. 功能需求（全量）

### 5.1 文档输入与标准化

#### 5.1.1 输入支持

- 文本类：`md`、`txt`、`docx`、`pptx`
- 非文本类：`pdf`、常见图片格式（`png`、`jpg`、`jpeg`、`bmp`、`tiff`、`webp`）

> 注：不支持旧版 `.doc` 和 `.ppt` 格式，仅支持 Office Open XML 格式（`.docx`、`.pptx`）。

#### 5.1.2 处理链路

- 文本类：直接结构化转换为 Markdown。
- 非文本类：统一经 OCR 识别后输出 Markdown。
- 所有链路必须输出统一 `MarkdownResult` 数据对象。

#### 5.1.3 回退与可追溯

- 转换失败自动重试并记录错误码。
- OCR 失败支持一次降级重试。
- 处理日志可按 traceId 查询。

### 5.2 OCR 能力

- 默认引擎：PaddleOCR。
- 支持模型目录探测与按需下载。
- 支持 CPU/GPU 设备策略切换。
- 复杂场景可扩展云 OCR 适配层（v1.2+）。

### 5.3 LLM 卡片生成

- 输入：标准化 Markdown。
- 输出：符合 `CardDraft` 规范的结构化对象数组。
- 支持策略（全部已实现）：
  - `Basic`（问答）
  - `Cloze`（完形填空）
  - `Concept`（概念解释）
  - `Key Terms`（关键术语）
  - `Single Choice`（单选题）
  - `Multiple Choice`（多选题）
  - `Image QA`（图片问答）
  - `Image Occlusion`（图片遮挡）
- 生成后必须做 JSON 修复、字段补全、合法性校验。

### 5.4 卡片审阅与编辑

- 结果预览：列表 + 单卡详情（截断预览，显示笔记类型与字段摘要）。
- 逐张编辑：支持逐张选择、字段级文本编辑、单卡删除。
- 卡片更新：支持对已推送卡片的内容更新。
- 批量操作：全选/取消、批量推送/导出。
- 校验反馈：在提交前明确指出错误字段与修复建议。

### 5.5 Anki 对接

- 协议：AnkiConnect `version: 6`。
- 能力：
  - 获取牌组与笔记类型。
  - `addNote` / `addNotes` 写入。
  - 写入前字段一致性校验。
- 降级：AnkiConnect 不可用时导出 `.apkg`。

### 5.6 配置与安全

- API Key 加密存储，不明文落盘。
- 多 LLM 供应商管理：支持 6 家供应商（OpenAI、DeepSeek、Moonshot、智谱、通义千问、Ollama），可新增/编辑/删除/切换。
- 代理配置：支持 HTTP 代理（`proxy_url`）。
- 生成参数：`temperature`（默认 0.3）、`max_tokens`（0 表示使用供应商默认值）。
- 本地路径、模型路径、设备参数可配置。
- 敏感信息默认不进入日志。

### 5.7 任务与可观测

- 每个任务全程带 traceId。
- 关键阶段耗时：转换、OCR、LLM、写入/导出。
- 错误码统一，错误信息可执行。

---

## 6. 详细业务流程

### 6.1 主流程（用户视角）

1. 选择文件（可多选）并配置目标牌组/笔记类型。
2. 执行转换与识别，生成标准化 Markdown。
3. 生成卡片草稿并进行预览/必要编辑。
4. 推送到 Anki；若连接失败则导出 APKG。
5. 查看结果统计、失败原因与修复建议。

### 6.2 异常流程

- OCR 模型缺失：提示并引导下载。
- AnkiConnect 不可达：给出检测结果与修复路径，并提供 APKG 导出。
- LLM 返回异常：自动重试并回显可诊断日志 ID。

### 6.3 状态机（任务）

`待处理 → 转换中 → 生成中 → 待确认 → 写入中/导出中 → 完成/失败`

---

## 7. 非功能性需求

### 7.1 性能

- 文本转 Markdown：P95 ≤ 8 秒/文件。
- OCR：P95 ≤ 5 秒/页（标准测试样本）。
- 单卡 LLM 生成：P95 ≤ 3 秒（网络稳定条件下）。

### 7.2 可靠性

- 文档标准化成功率 ≥ 98%。
- 关键外部调用（LLM、AnkiConnect）具备重试与超时控制。

### 7.3 可用性

- 新用户首次上手 10 分钟内可完成首个端到端流程。
- 核心路径操作步骤不超过 6 步。

### 7.4 兼容性

- Windows 10 及以上。
- Anki 当前活跃桌面版本。

### 7.5 安全性

- API Key 加密存储，不明文落盘。
- 传输默认使用安全通道。

---

## 8. 数据对象与规范约束

- 卡片对象统一遵循 `docs/AnkiSmart 闪卡格式规范.md`。
- OCR 模型目录、环境变量、自动下载机制遵循 `docs/OCR 模型目录与自动下载说明.md`。
- UI 视觉与组件规范遵循 `docs/design_specs.md`。

---

## 9. 风险与应对

| 风险 | 影响 | 应对 |
|---|---|---|
| PaddleOCR 模型体积较大（~150 MB） | 首次安装/下载耗时长，用户流失 | 按需下载 + 进度回调 + 缓存复用 |
| LLM API 调用成本 | 大量生成时费用累积 | 支持本地 Ollama 免费方案；temperature/max_tokens 可调 |
| Anki 版本兼容性 | AnkiConnect 协议变更导致写入失败 | 协议版本固定 version:6；动态字段映射；健康检查 |
| 打包分发复杂度 | PaddleOCR + PySide6 体积大，安装门槛高 | v1.1 规划打包方案（PyInstaller / Nuitka），模型按需下载 |
| `.doc`/`.ppt` 旧格式不支持 | 用户持有旧格式文件无法导入 | 明确提示仅支持 `.docx`/`.pptx`，建议用户先转换格式 |
| LLM 输出不稳定 | JSON 解析失败，卡片质量波动 | 结构化提示词 + JSON 修复 + 后处理校验 |

---

## 10. 验收基线

- 功能验收：全链路在标准样例集可稳定运行。
- 质量验收：关键模块单元测试覆盖率目标 ≥ 80%。
- 交付验收：文档、测试报告、发布说明齐备。

---

## 11. 参考资料

1. AnkiConnect 官方仓库（SourceHut）：https://git.sr.ht/~foosoft/anki-connect
2. Anki 官方发布页：https://github.com/ankitects/anki/releases
3. Anki Manual - Note Types：https://docs.ankiweb.net/getting-started.html#note-types
4. PySide6 官方文档：https://doc.qt.io/qtforpython-6/
