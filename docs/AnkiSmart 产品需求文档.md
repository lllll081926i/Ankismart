# AnkiSmart 产品需求文档

**文档版本**：1.3

**创建日期**：2026年2月10日

**作者**：Manus AI

## 1. 引言

### 1.1 产品愿景
AnkiSmart 旨在革新 Anki 闪卡的制作流程，通过集成先进的 OCR（光学字符识别）技术和 LLM（大语言模型），将传统耗时且重复的手动内容录入模式，升级为高效、智能的“内容提取-闪卡生成”自动化工作流。本产品致力于帮助 Windows 用户更便捷、更高效地将各类学习资料（如电子书、PDF、网页内容、图片等）转化为高质量的 Anki 闪卡，从而显著提升学习效率和知识内化效果。

### 1.2 产品目标

*   **提高效率**：将用户创建 Anki 闪卡的时间缩短至少 50%。
*   **提升质量**：利用 LLM 的语义理解能力，生成更精准、更符合学习习惯的闪卡内容。
*   **简化操作**：提供直观的用户界面和流畅的工作流程，降低用户使用门槛。
*   **Windows 平台优化**：针对 Windows 操作系统进行深度优化，提供原生应用般的体验。

### 1.3 目标用户

*   **学生**：需要记忆大量知识点（如医学、法律、语言学习）的学生群体。
*   **专业人士**：需要持续学习新知识、更新技能的职场人士。
*   **Anki 资深用户**：寻求更高效闪卡制作工具的现有 Anki 用户。

## 2. 功能需求

AnkiSmart 的核心功能围绕“获取内容”、“智能处理”和“Anki 对接”三大模块展开。

### 2.1 文档输入与标准化 (Markdown 中间层)

该模块负责统一接收多种输入文档，并将其标准化为 Markdown，作为后续 LLM 处理的唯一中间格式。其主要功能包括：

*   **文本格式直接转 Markdown**：支持 `ppt/pptx`、`doc/docx`、`txt`、`md` 等输入；其中 `md` 直接使用，其他文本类文档解析后直接转为 Markdown。
*   **非文本格式统一 OCR 流程**：除文本格式外，其他格式统一先转换为 PDF，再进行 OCR，最终输出 Markdown。
*   **批量导入与任务队列**：支持多文件批量导入、后台并行转换、失败重试与任务状态可视化。
*   **结构保留与清洗**：尽可能保留标题、列表、表格、段落层级；并进行乱码修复、空白清理与段落重组。
*   **多语言与特殊内容支持**：支持至少中、英、日、韩识别，并兼顾公式、符号、代码片段等内容的可读性。

#### 2.1.1 输入格式支持矩阵

| 输入类别 | 示例扩展名 | 处理策略 | 统一输出 |
| :--- | :--- | :--- | :--- |
| 文本格式 | `md` | 直接透传并规范化 | `Markdown` |
| 文本格式 | `txt` | 按编码检测读取并转结构化段落 | `Markdown` |
| 文本格式 | `doc/docx` | 文档结构解析后转 Markdown | `Markdown` |
| 文本格式 | `ppt/pptx` | 按页/文本框抽取后转 Markdown | `Markdown` |
| 非文本格式 | `pdf`、图片类等 | 统一转 PDF 后执行 OCR | `Markdown` |

#### 2.1.2 标准化流水线

1. **文件识别**：按 MIME 与扩展名双重判断输入类型。
2. **路线分流**：文本格式走“直接转 Markdown”；非文本走“PDF → OCR → Markdown”。
3. **结构清洗**：统一标题层级、列表缩进、表格语法与空白规则。
4. **质量检查**：检查空文档、乱码率、段落完整性与最小字数阈值。
5. **入库缓存**：保存标准化 Markdown 与处理日志，供预览与回溯。

#### 2.1.3 失败回退策略

*   **转换失败回退**：文本解析失败时自动切换到“转 PDF 后 OCR”。
*   **OCR 失败回退**：自动重试并支持手动切换 OCR 引擎。
*   **部分成功策略**：按页保留已成功内容，并标记失败页供用户补救。
*   **可追溯性**：每个文件保留处理阶段状态、错误码与可执行修复建议。

### 2.2 知识加工与转化 (LLM 模块)

此模块是 AnkiSmart 的核心智能引擎，利用大语言模型将标准化后的 Markdown 内容转化为结构化、高质量的 Anki 闪卡内容。其主要功能包括：

*   **智能内容提炼**：LLM 将根据用户预设的“笔记类型”（例如“基本卡片”、“完形填空”、“概念解释”）和用户提供的文本内容，自动识别并提炼出关键信息，如定义、概念、关键词、例句、因果关系等。
*   **多种卡片生成策略**：
    *   **问答对 (Basic)**：从文本中提取核心概念及其解释，生成“问题-答案”形式的闪卡。
    *   **完形填空 (Cloze Deletion)**：自动识别文本中的关键术语或短语，并将其转换为完形填空形式的闪卡，支持多重挖空。
    *   **概念解释 (Concept Explanation)**：针对复杂概念，LLM 可生成包含定义、特点、应用场景、示例等详细解释的闪卡。
    *   **自定义模板映射**：用户可以根据 Anki 中已有的笔记类型，自定义 LLM 生成内容的字段映射关系，确保生成的卡片符合个人学习习惯。
*   **智能内容润色与优化**：
    *   **OCR 错误纠正**：LLM 能够识别并纠正 OCR 过程中可能产生的文字错误或乱码，提高文本质量。
    *   **语言风格优化**：根据用户选择的语言风格（如学术、简洁、口语化），对生成的卡片内容进行润色，使其更易于理解和记忆。
    *   **记忆科学优化**：LLM 可根据记忆科学原理（如精细加工、联想记忆），在卡片内容中建议添加相关提示或助记符。
*   **用户交互式调整**：在卡片生成后，提供直观的 UI 界面供用户预览、编辑和微调 LLM 生成的内容，包括修改文本、调整字段、选择挖空位置等。
*   **卡片草稿标准结构**：统一生成 `deckName`、`noteType`、`fields`、`tags`、`media`、`options` 六类字段，作为入 Anki 前的中间对象。
*   **生成约束规则**：默认“一卡一知识点”，限制过长答案，支持去重检测与相似卡片合并建议。

### 2.3 Anki 无缝对接

该模块确保 AnkiSmart 能够与用户的 Anki 桌面客户端进行高效、稳定的数据交互。

*   **AnkiConnect 集成**：通过调用 AnkiConnect 插件提供的 HTTP API [1]，实现与 Anki 客户端的实时双向通信。这包括：
    *   **牌组列表获取**：自动获取用户 Anki 客户端中所有可用的牌组列表。
    *   **笔记类型/模板获取**：自动获取用户 Anki 客户端中所有可用的笔记类型及其字段结构。
    *   **卡片创建与更新**：将 AnkiSmart 生成的闪卡内容，按照用户指定的牌组和笔记类型，推送到 Anki 客户端中。
    *   **官方格式支持**：支持 Anki 官方支持的笔记类型与字段结构，并支持媒体字段（图片/音频/视频）映射与写入。
        *   **内置笔记类型覆盖**：`Basic`、`Basic (and reversed card)`、`Basic (optional reversed card)`、`Basic (type in the answer)`、`Cloze`、`Image Occlusion` [5]。
        *   **自定义笔记类型兼容**：支持读取用户已有自定义 note type 并完成字段映射。
*   **协议兼容与错误处理**：
    *   请求统一使用 `version: 6`，并处理 `result`/`error` 双字段响应。
    *   默认连接 `127.0.0.1:8765`，启动前检查 AnkiConnect 服务可用性。
    *   当用户启用 API Key 时，请求需携带 `key` 字段，并提供配置校验与错误提示。
    *   在网络异常、AnkiConnect 未运行、字段映射不匹配等场景下，提供可执行的修复指引。

## 3. 非功能性需求

### 3.1 性能

*   **文本转 Markdown 速度**：单个常见文档（Word/PPT/TXT）P95 转换时间 ≤ 8 秒。
*   **OCR 转 Markdown 速度**：单页 A4 文档的 PDF-OCR-Markdown 流程 P95 ≤ 5 秒。
*   **LLM 响应速度**：在网络状况良好的情况下，单张卡片生成应在 3 秒内完成。
*   **批量处理**：支持在后台高效处理批量文件，不阻塞用户界面。
*   **资源占用**：软件在空闲状态下应保持较低的 CPU 和内存占用。

### 3.5 可靠性与可观测性

*   **成功率目标**：文档标准化流水线整体成功率 ≥ 98%（按文件计）。
*   **重试机制**：转换/OCR/Anki 写入均支持指数退避重试与熔断。
*   **链路追踪**：每次任务生成唯一 `traceId`，贯穿导入、转换、生成、写入全流程。
*   **可审计日志**：保留结构化日志与关键事件时间戳，支持问题复盘。

### 3.2 可用性

*   **直观的用户界面**：采用现代化的 UI/UX 设计，确保用户能够轻松上手并高效使用。
*   **流程快捷操作**：提供可自定义快捷键，方便用户快速触发导入、转换、生成卡片等操作。
*   **多语言界面**：支持中文和英文界面。
*   **安装与部署**：提供简洁的 Windows 安装包，安装过程应自动化。

### 3.3 兼容性

*   **操作系统**：支持 Windows 10 及以上版本。
*   **Anki 版本**：兼容当前活跃 Anki 桌面版本，建立持续回归测试矩阵（按 Anki 官方发布节奏更新）[2]。
*   **OCR/LLM 服务**：支持多种 OCR 和 LLM 服务提供商，允许用户根据需求选择。

### 3.4 安全性

*   **数据隐私**：用户通过 OCR 识别和 LLM 处理的文本内容，应在本地进行处理或通过加密通道传输至云端服务，确保用户数据隐私。
*   **API Key 管理**：用户配置的 LLM API Key 应加密存储，不以明文形式暴露。

## 4. 技术架构与选型

### 4.1 客户端框架

*   **PySide6（原生 Python 前端）**：基于 Qt for Python 的 Windows 桌面客户端。
    *   **前端路线约束**：统一采用原生 Python 前端（PySide6），不再使用 React 前端。
    *   **优势**：原生桌面交互能力强、与 Python 后端技术栈一致、部署链路统一。
    *   **与后端协同**：优先同进程模块化调用；需要隔离时可通过本地 HTTP 与 FastAPI 服务通信。

### 4.2 OCR 引擎

*   **PaddleOCR**：优先考虑，其在中文识别方面表现优异，支持本地部署或通过 API 调用。
*   **Google Cloud Vision API / Azure Read API**：作为备选或高级选项，提供更高的识别精度和更广泛的语言支持。
*   **统一输入链路**：非文本输入统一先转 PDF，再执行 OCR，最终输出 Markdown。

### 4.3 LLM 引擎

*   **云端 LLM 服务**：
    *   **OpenAI API**：提供 GPT-4o 等先进模型，适用于高质量内容生成。
    *   **DeepSeek API**：提供高性价比的中文优化模型，适合大规模应用。
    *   **Claude API**：提供长上下文处理能力，适用于处理长篇文档。
*   **本地 LLM 部署**：
    *   **Ollama**：支持在本地运行多种开源 LLM 模型（如 Llama 3, Qwen 2.5），为用户提供数据隐私和离线使用的选择。

### 4.4 Anki 对接

*   **AnkiConnect**：通过 HTTP 请求与 Anki 客户端进行通信，是社区主流外部集成方式 [1]。

### 4.5 数据存储

*   **本地配置**：用户配置、API Key 等敏感信息加密存储在本地文件系统。
*   **临时数据**：OCR 识别的中间文本、LLM 生成的卡片草稿等临时数据，可在本地缓存，用户确认后清除。

### 4.6 后端服务

*   **Python + FastAPI**：作为统一后端服务层，负责文档标准化、OCR 编排、LLM 调用、卡片结构化与 AnkiConnect 适配。
*   **统一中间格式**：全链路以 Markdown 作为中间层，降低不同输入格式对下游的影响。
*   **任务执行模型**：使用异步任务队列处理转换/OCR/LLM 长耗时任务，避免阻塞 UI。
*   **可观测性**：记录结构化日志、请求追踪 ID、关键耗时指标（转换/OCR/LLM/Anki 写入）。
*   **部署策略**：Windows 打包时将 Python 运行时与依赖一并分发，降低用户环境配置成本。

### 4.7 核心模块划分

*   **Ingestion 模块**：文件识别、类型分流、批处理调度。
*   **Converter 模块**：文本直转 Markdown 与非文本 PDF 中转。
*   **OCR 模块**：PDF 分页识别、文本拼接、结构重建。
*   **CardGen 模块**：Markdown 到卡片草稿的提示词编排与后处理。
*   **Anki Gateway 模块**：AnkiConnect 请求封装、字段映射、幂等写入。
*   **Task/Telemetry 模块**：任务队列、状态机、日志与指标上报。

## 5. 未来迭代计划

*   **更丰富的卡片类型**：支持图像遮挡 (Image Occlusion)、音频嵌入等高级 Anki 卡片类型。
*   **知识图谱构建**：利用 LLM 自动构建知识点之间的关联，生成更具结构化的学习内容。
*   **多平台支持**：考虑未来扩展到 macOS 或 Linux 平台。
*   **社区模板分享**：允许用户分享和下载自定义的 LLM 提炼模板和卡片生成策略。

## 6. 参考文献

[1] AnkiConnect 官方仓库 (SourceHut). URL: https://git.sr.ht/~foosoft/anki-connect
[2] Anki 官方发布页. URL: https://github.com/ankitects/anki/releases
[3] FastAPI 官方文档. URL: https://fastapi.tiangolo.com/
[4] PySide6 官方文档. URL: https://doc.qt.io/qtforpython-6/
[5] Anki Manual - Note Types. URL: https://docs.ankiweb.net/getting-started.html#note-types
[6] PySide6 Deploy 官方文档. URL: https://doc.qt.io/qtforpython-6/deployment/deployment-pyside6-deploy.html
[7] AnkiSmart 闪卡格式规范. 文件: `AnkiSmart 闪卡格式规范.md`
